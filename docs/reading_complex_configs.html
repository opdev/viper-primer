<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Reading Complex Configuration - A Primer on Viper</title>
        <!-- Custom HTML head -->
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="introduction.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="what_is_viper.html"><strong aria-hidden="true">1.1.</strong> What is Viper</a></li><li class="chapter-item expanded "><a href="reading_simple_configs.html"><strong aria-hidden="true">1.2.</strong> Reading Simple Configuration</a></li><li class="chapter-item expanded "><a href="reading_complex_configs.html" class="active"><strong aria-hidden="true">1.3.</strong> Reading Complex Configuration</a></li></ol></li><li class="chapter-item expanded "><a href="hands_on.html"><strong aria-hidden="true">2.</strong> Hands on with Viper</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="defining_our_config_file.html"><strong aria-hidden="true">2.1.</strong> Configuring Viper</a></li><li class="chapter-item expanded "><a href="reading_config_values.html"><strong aria-hidden="true">2.2.</strong> Reading Config Values</a></li><li class="chapter-item expanded "><a href="the_viper_singleton.html"><strong aria-hidden="true">2.3.</strong> What's actually happening under the hood</a></li><li class="chapter-item expanded "><a href="init_function.html"><strong aria-hidden="true">2.4.</strong> The init function</a></li><li class="chapter-item expanded "><a href="maps_and_slices.html"><strong aria-hidden="true">2.5.</strong> Maps and Slices</a></li><li class="chapter-item expanded "><a href="env_vars.html"><strong aria-hidden="true">2.6.</strong> Adding Environment Variables</a></li><li class="chapter-item expanded "><a href="env_vars_nested.html"><strong aria-hidden="true">2.7.</strong> Setting Nested Keys via Environment</a></li><li class="chapter-item expanded "><a href="binding_to_structs.html"><strong aria-hidden="true">2.8.</strong> Binding to structs</a></li><li class="chapter-item expanded "><a href="spanning_packages.html"><strong aria-hidden="true">2.9.</strong> Reading configuration across packages</a></li><li class="chapter-item expanded "><a href="setting_defaults.html"><strong aria-hidden="true">2.10.</strong> Setting Defaults</a></li><li class="chapter-item expanded "><a href="setting_values.html"><strong aria-hidden="true">2.11.</strong> Setting Values</a></li><li class="chapter-item expanded "><a href="other_files.html"><strong aria-hidden="true">2.12.</strong> Reading other config files</a></li><li class="chapter-item expanded "><a href="other_formats.html"><strong aria-hidden="true">2.13.</strong> Reading other config formats</a></li><li class="chapter-item expanded "><a href="cobra_integration.html"><strong aria-hidden="true">2.14.</strong> Integrating With Cobra</a></li></ol></li><li class="chapter-item expanded "><a href="final_thoughts.html"><strong aria-hidden="true">3.</strong> Final Thoughts</a></li><li class="chapter-item expanded "><a href="appendix.html"><strong aria-hidden="true">4.</strong> Appendix</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">A Primer on Viper</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="reading-complex-configuration"><a class="header" href="#reading-complex-configuration">Reading Complex Configuration</a></h1>
<p>So we've already got a simple way to read in a file from disk and map it to a
struct in Go, allowing us to make decisions based on the user's configuration.</p>
<p>What if we want the user to be able to pass us JSON instead of YAML? Well that's
not too bad. We just add a few more struct tags like this:</p>
<pre><code class="language-go">type Configuration struct {
	LogLevel             string `yaml:&quot;logLevel&quot; json:&quot;loglevel&quot;`
	MagicFeatureEnabled  bool   `yaml:&quot;magicFeatureEnabled&quot; json:&quot;magicFeatureEnabled&quot;`
	SomethingNeatEnabled bool   `yaml:&quot;somethingNeatEnabled&quot; json:&quot;somethingNeatEnabled&quot;`
}
</code></pre>
<p>And then we can use the <a href="https://pkg.go.dev/encoding/json">encoding/json</a>
library which also has an <code>Unmarshal</code> function. Reading a file from disk has
already been done, so we'd just need to read the file at both a <code>config.json</code> or
<code>config.yaml</code> path and then repeat the process as we did with the YAML
configuration.</p>
<p>Easy peasy.</p>
<h2 id="accepting-configuration-through-environment"><a class="header" href="#accepting-configuration-through-environment">Accepting configuration through environment</a></h2>
<p>These days, environment variables are all the rage. They're easy to change in
continuous integration, test environments, etc. So let's add an environment
variable for each of these... something like:</p>
<pre><code class="language-go">const (
	EnvLogLevel             = &quot;MYAPP_LOG_LEVEL&quot;
	EnvMagicFeatureEnabled  = &quot;MYAPP_MAGIC_FEATURE_ENABLED&quot;
	EnvSomethingNeatEnabled = &quot;MYAPP_SOMETHING_NEAT_ENABLED&quot;
)
</code></pre>
<p>So these are our environment variable keys, and so we need to look for each of
them. In our example application, we'll enforce that environment
variables override the configuration file. Establishing and documenting
precedence is important, so that users know exactly how and why a value is being
overridden! </p>
<p>So now our <code>main.go</code> has to handle the precedence, so we'll read the
configuration first, and then we'll read the environment.</p>
<pre><code class="language-go">package main

import (
	&quot;fmt&quot;
	&quot;os&quot;
	&quot;strings&quot;

	&quot;gopkg.in/yaml.v3&quot;
)

const (
	EnvLogLevel             = &quot;MYAPP_LOG_LEVEL&quot;
	EnvMagicFeatureEnabled  = &quot;MYAPP_MAGIC_FEATURE_ENABLED&quot;
	EnvSomethingNeatEnabled = &quot;MYAPP_SOMETHING_NEAT_ENABLED&quot;
)

func main() {
	// read the configuration file from disk and store it in our struct.
	d, _ := os.ReadFile(&quot;config.yaml&quot;)
	var cfg Configuration
	yaml.Unmarshal(d, &amp;cfg)

	// override the configuration with environment variables
	if key := os.Getenv(EnvLogLevel); key != &quot;&quot; {
		cfg.LogLevel = key
	}

	if key := os.Getenv(EnvMagicFeatureEnabled); key != &quot;&quot; {
		envValue := false
		if strings.ToLower(key) == &quot;true&quot; {
			envValue = true
		}

		cfg.MagicFeatureEnabled = envValue
	}

	if key := os.Getenv(EnvSomethingNeatEnabled); key != &quot;&quot; {
		envValue := false
		if strings.ToLower(key) == &quot;true&quot; {
			envValue = true
		}

		cfg.SomethingNeatEnabled = envValue
	}

	// run our business logic
	fmt.Println(&quot;The Log Level is: &quot;, cfg.LogLevel)
	fmt.Println(&quot;We are using the Magic Feature: &quot;, cfg.MagicFeatureEnabled)
	fmt.Println(&quot;We are using Something Neat &quot;, cfg.SomethingNeatEnabled)
}

type Configuration struct {
	LogLevel             string `yaml:&quot;logLevel&quot; json:&quot;loglevel&quot;`
	MagicFeatureEnabled  bool   `yaml:&quot;magicFeatureEnabled&quot; json:&quot;magicFeatureEnabled&quot;`
	SomethingNeatEnabled bool   `yaml:&quot;somethingNeatEnabled&quot; json:&quot;somethingNeatEnabled&quot;`
}
</code></pre>
<p>Without modifying the environment, our output looks like this (values from our
configuration file):</p>
<pre><code>$ go run .
The Log Level is:  debug
We are using the Magic Feature:  true
We are using Something Neat  false
</code></pre>
<p>But if we modify our environment, we see that our environment's values win out
over the configuration file.</p>
<pre><code>$ MYAPP_LOG_LEVEL=info go run .
The Log Level is:  info
We are using the Magic Feature:  true
We are using Something Neat  false
</code></pre>
<hr />
<p>So far, things have been pretty simple! But more than half of our main.go file
is focused on handling our configuration... and we haven't even scratched the
surface!</p>
<p>What if we wanted to have more complex configurations, with maps or arrays?</p>
<pre><code class="language-yaml">logging:
	level: debug
	file: /var/log/myapp.log
magicFeature:
	enabled: true
	backends:
	- awesome.example.com:8080
	- epic.example.com:8080
somethingNeat: 
	enabled: true
	endpoint: https://neat.example.com/v1/	
</code></pre>
<p>Building out a struct in Go is simple enough, but now each of these keys needs a
corresponding environment variable. And for each environment variable, we'll need to
build out logic that replaces the values read in from our config file with the values 
read in from the environment.</p>
<p>What about default values? If the user didn't provide a value, but we need it to
run our logic, it stands to reason that a sane default should be used. We'll
need to codify that default either by building out a <code>DefaultConfig</code> out of our
<code>Configuration</code> struct, reading a default from disk, or really any other way
that you can architect your solution.</p>
<p>None of these problems are too complex to solve on your own, but the Viper
library aims to help speed up your development by giving you simple hooks that
solve this problem without having to write your own code to do so.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="reading_simple_configs.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                            <a rel="next" href="hands_on.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="reading_simple_configs.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                    <a rel="next" href="hands_on.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
    </body>
</html>
